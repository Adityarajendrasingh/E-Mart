<!DOCTYPE html>
<html lang="en">
<!--Header-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User_SignUp | www.emart.com</title>
    <?php include('links.php'); ?>
</head>
<?php include('header_index.php');?>
<!--/Header-->
<main id="main-site" class="bg-white">
    <div class="container">
        <div class="register_user">
            <div class="row">
                <div class="col-xl-6 col-12">
                    <div class="left-side">
                        <div class="banner">
                            <img src="images/login.png" alt="" class="img-fluid">
                        </div>
                    </div>
                </div>
                <div class="col-xl-6 col-12">
                    <div class="right-side">
                        <div class="logo">
                            <a href="index.html"><img src="images/emart_logo.PNG" alt=""></a>
                            <span class="text-center">E-Mart</span>
                        </div>
                        <div class="greeting">
                            <span>Looks like you're here!</span>
                        </div>
                        <div class="register_form">
                            <form class="form needs-validation" id="register_form" novalidate>
                                <div class="form-group  ">
                                    <div class="row">
                                        <div class="col">
                                            <h5>First Name</h5>
                                            <input type="text" class="form-control w-100 text-capitalize"
                                                placeholder="First name" name="f_name" id="f_name"
                                                onkeypress="return event.charCode != 32" required minlength="4">
                                            <div class="invalid-feedback">
                                                Please enter a valid name.
                                            </div>
                                        </div>
                                        <div class="col">
                                            <h5>Last Name</h5>
                                            <input type="text" class="form-control w-100 text-capitalize"
                                                placeholder="Last name" name="l_name" id="l_name"
                                                onkeypress="return event.charCode != 32" required minlength="4">
                                            <div class="invalid-feedback">
                                                Please enter a valid last name.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <h5>Mobile Number</h5>
                                    <input type="text" class="form-control br-radius-zero" name="mb_no" id="mb_no"
                                        placeholder="10-Digit Mobile Number"
                                        onkeypress="return /[0-9]/i.test(event.key)" minlength="10" maxlength="10"
                                        title="Please enter a valid mobile number" required />
                                    <div class="invalid-feedback">
                                        Please enter a valid Mobile Number.
                                    </div>
                                </div>
                                <div class="form-radio-button">
                                    <h5>Gender</h5>
                                    <label class="radio-inline">
                                        <input type="radio" id="gender_" name="genders_" value="male" required checked>
                                        Male
                                    </label>
                                    <label class="radio-inline">
                                        <input type="radio" id="gender_" name="genders_" value="female"> Female
                                    </label>
                                    <label class="radio-inline">
                                        <input type="radio" id="gender_" name="genders_" value="other"> Other
                                    </label>
                                </div>
                                <div class="form-group">
                                    <h5>Email ID</h5>
                                    <div class="email_id d-flex justify-content-space-between">
                                        <input type="email" class="form-control br-radius-zero " name="uemail"
                                            id="useremail1" placeholder="Email ID"
                                            onkeypress="return event.charCode != 32"
                                            title="Please enter valid and active Email Id" maxlength="100" required />
                                        <button type="button" 
                                            class="btn btn-warning w-50 mx-2 send_otp" >Send OTP</button>
                                        <input type="text"  placeholder="OTP"
                                            class="form-control br-radius-zero mx-1 email_otp_input verify_opt" hidden>
                                        <button type="button" 
                                            class="btn btn-warning w-50 mx-2 verify_otp" hidden>Verify OTP</button>
                                        <div class="invalid-feedback" style="flex-direction: row;">
                                            Please enter a valid Email Id.
                                        </div>
                                    </div>
                                    <span class="mt-1 email_msg" style="font-size:95%;"></span>
                                </div>
                                <div class="form-group">
                                    <h5>Create Password</h5>
                                    <input type="password" class="form-control br-radius-zero" name="pass_word"
                                        id = "pass_word" placeholder="Password" onkeypress="return event.charCode != 32"
                                        minlength="6" maxlength="25" required />
                                    <div class="invalid-feedback">
                                        Please enter a valid password.
                                    </div>
                                </div>
                                <div class="form-action register-submit-buttton pt-2">
                                    <input type="submit" value="First Verify your email " name="" id="user_register"
                                        class="user_register btn btn-outline-info w-100" disabled />
                                </div>
                                <div class="existing-user pt-2 ">
                                    <a href="user_login.html" class="btn btn-outline-primary w-100 p-1">Existing User?
                                        Login Here</a>
                                </div>
                            </form>
                        </div>
                    </div>


                </div>
            </div>
        </div>

        <br>
    </div>

</main>
<!--footer-->
<?php include('footer.php');?>
<!--/footer-->

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<?php
    if(isset($_SESSION['msg']) && $_SESSION['msg']!='')
{
?>
<script>

    swal.fire({
        title: "<?php echo $_SESSION['msg'];?>",
        icon: "<?php echo $_SESSION['msg_status'];?>",
        button: "OK",
    });
</script>
<?php
unset($_SESSION['msg']);
}
?>
<script>
    $(document).ready(function () {
        $('#user_register').click(function () {
            var f_name = $("#f_name").val().trim();
            var l_name = $("#l_name").val().trim();
            var mobileno = $("#mb_no").val().trim();
            var email = $("input[name=uemail]").val().trim();
            var password = $("input[name=pass_word]").val().trim();
            var $option = $('input[name=genders_]:checked'); // $option is the $ wrapped HTML element
            var my = $option.val();

        });

    });
</script>

<script type="text/javascript">
    $(document).ready(function () {
        function isEmail(email) {
            return /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(
                email
            );
        }
        $(".send_otp").on('click',function(){
            send_otp();
        })
        $(".verify_otp").on('click',function(){
            verify_otp();
        })
        function send_otp() {
            $(".email_msg").html("");
            var email = $("#useremail1").val().trim();
            if (email == "") {
                alert('ok');
                $(".email_msg").css("color", "red");
                $(".email_msg").html("Please enter your email id ");
            } else if (!isEmail(email)) {
                $(".email_msg").css("color", "red");
                $(".email_msg").html("Please enter a valid email Id ");
            } else {
                $(".send_otp").html("Please wait!!");
                $(".send_otp").attr("disabled", true);
                $.ajax({
                    url: "send_otp.php",
                    type: "post",
                    data: { email: email },
                    success: function (response) {
                        var result = JSON.parse(response);

                        if (result.exists) {
                            $(".send_otp").html("Send OTP");
                            $(".send_otp").attr("disabled", false);
                            $(".email_msg").addClass("text-danger");
                            $(".email_msg").html("Email ID already exists");
                        } else if (result.success) {
                            $("input[name=uemail]").attr("readonly", true);
                            $(".email_otp_input").attr("hidden", false);
                            $(".send_otp").attr("hidden", true);
                            $(".verify_otp").attr("hidden", false);
                        } else if (result.error) {
                            $(".send_otp").html("Send OTP");
                            $(".send_otp").attr("disabled", false);
                            $(".email_msg").addClass("text-danger");
                            $(".email_msg").html(jsonResponse.error);
                        } else {
                            $(".email_msg").html("");
                            $(".email_msg").removeClass("text-danger");
                            $(".email_msg").addClass("text-info");
                            $(".email_msg").html("Please try after sometime ");
                            $(".send_otp").html("Send OTP");
                            $(".send_otp").attr("disabled", false);
                        }
                    },
                });
            }
        }
        function verify_otp() {
            $(".email_msg").html("");
            var otp = $(".email_otp_input").val().trim();
            if (otp == "") {
                $(".email_msg").css("color", "red");
                $(".email_msg").html("Please enter your otp ");
            } else {
                $(".email_msg").html("");
                $.ajax({
                    url: "check_otp.php",
                    type: "post",
                    data: { otp: otp },
                    success: function (response) {
                        let result = JSON.parse(response);
                        if (result.success) {
                            $(".email_msg").html("");
                            $("input[name=uemail]").attr("readonly", true);
                            $(".email_otp_input").attr("hidden", true);
                            $(".send_otp").attr("hidden", true);
                            $(".verify_otp").attr("hidden", true);
                            $(".email_msg").addClass("text-success");
                            $(".email_msg").html("Email id is verified");
                            $(".user_register").attr("disabled", false);
                            $(".user_register").attr("value", "Register");
                        } else {
                            $(".email_msg").html("");
                            $(".email_msg").css("color", "red");
                            $(".email_msg").html("Please enter  a valid otp ");
                        }
                    },
                });
            }
        }

        function togglePassword() {
            var $passwordField = $("#pass_word");
            var type = $passwordField.attr("type");
            if (type == "password") {
                $passwordField.attr("type", "text");
            } else {
                $passwordField.attr("type", "password");
            }
        }


        $('.verify_otp').on('click', function () {
            verify_otp();
        });
    });

</script>
<script>
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
        'use strict';
        window.addEventListener('load', function () {
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.getElementsByClassName('needs-validation');
            // Loop over them and prevent submission
            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    else {
                        var f_name = $("#f_name").val().trim();
                        var l_name = $("#l_name").val().trim();
                        var mobileno = $("#mb_no").val().trim();
                        var email = $("input[name=uemail]").val().trim();
                        var password = $("input[name=pass_word]").val().trim();
                        var $option = $('input[name=genders_]:checked'); // $option is the $ wrapped HTML element
                        var my = $option.val();

                        $.ajax({
                            url: 'usersignup.php',
                            type: 'post',
                            data: { fname: f_name, lname: l_name, mobileno: mobileno, email: email, password: password, gen: my },
                            success: function (result) {
                                console.log(result);
                                let obj = JSON.parse(result);
                                if(obj.success){
                                    // alert('ok');
                                    window.location.href = "http://localhost/E-mart/user_login.html";
                                }
                            }
                        });
                    }
                    form.classList.add('was-validated');

                }, false);

            });
        }, false);
    })

        ();
</script>